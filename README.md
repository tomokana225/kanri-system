# 授業予約システム

生徒がクラスを予約し、教師がスケジュールを確認し、管理者がプラットフォームを管理するための、役割ベースの包括的な予約システムです。Firebase（Authentication, Firestore）と連携し、リアルタイムでのデータ更新や安全な認証機能を備えています。

## ✨ 主な機能

- **役割ベースのアクセス制御**: 生徒、先生、管理者の3つの役割。
- **Firebase連携**: Authenticationによる安全な認証と、Firestoreによるリアルタイムなデータ管理。
- **ユーザー管理**: 管理者はアプリ内から生徒や先生のプロファイルを作成可能。
- **スケジュール作成**: 管理者は先生の授業スケジュールを簡単に作成。
- **予約システム**: 生徒はカレンダーから直感的に授業を予約。
- **メッセージ機能**: 生徒と先生が1対1でメッセージを送受信可能。
- **リアルタイム通知**: 予約やメッセージに関する更新をアプリ内でリアルタイムに通知。

## 🛠️ セットアップ手順

このアプリケーションをあなたの環境で動かすためには、Firebaseプロジェクトのセットアップが必要です。

### ステップ1: Firebaseプロジェクトの作成

1.  [Firebase コンソール](https://console.firebase.google.com/)にアクセスし、新しいプロジェクトを作成します。
2.  プロジェクトを作成したら、**Webアプリケーション** (`</>`) を追加します。
3.  アプリの登録時に表示される `firebaseConfig` オブジェクトの値をメモしておきます。これらは後でCloudflareで設定します。

### ステップ2: Cloudflare Pagesへのデプロイ

1.  このリポジトリをあなたのGitHubアカウントにフォークします。
2.  Cloudflareダッシュボードにログインし、`Pages` > `プロジェクトを作成` > `Gitに接続` を選択します。
3.  あなたのフォークしたリポジトリを選択し、デプロイを開始します。
4.  **ビルド設定**は以下のように設定します。
    -   **フレームワークプリセット**: `Vite`
    -   **ビルドコマンド**: `vite build`
    -   **ビルド出力ディレクトリ**: `dist`

### ステップ3: 環境変数の設定 (最重要)

Cloudflare PagesがFirebaseに接続するために、APIキーなどを設定します。

1.  Cloudflare Pagesのプロジェクトダッシュボードで `設定` > `環境変数` を開きます。
2.  `本番環境` のセクションで、**「環境変数を追加」** をクリックし、以下の変数を**すべて**設定します。
    -   **警告: 「シークレットを暗号化」のチェックは入れないでください。** これらはビルド時に必要な公開キーであり、シークレットとして設定するとアプリがキーを読み取れずエラーになります。

| 変数名                          | 値 (ステップ1でメモしたもの)      |
| ------------------------------- | --------------------------------- |
| `FIREBASE_API_KEY`              | `apiKey`                          |
| `FIREBASE_AUTH_DOMAIN`          | `authDomain`                      |
| `FIREBASE_PROJECT_ID`           | `projectId`                       |
| `FIREBASE_STORAGE_BUCKET`       | `storageBucket`                   |
| `FIREBASE_MESSAGING_SENDER_ID`  | `messagingSenderId`               |
| `FIREBASE_APP_ID`               | `appId`                           |
| `FIREBASE_MEASUREMENT_ID`       | `measurementId` (存在する場合)    |

設定後、**「再デプロイ」** を行い、変更を反映させてください。

### ステップ4: Firebaseサービスの有効化

#### 1. Authentication (認証)

1.  Firebaseコンソールの `Authentication` > `Sign-in method` タブを開きます。
2.  「**メール/パスワード**」プロバイダを有効にします。

#### 2. Firestore Database (データベース)

1.  Firebaseコンソールの `Firestore Database` を開きます。
2.  「**データベースの作成**」ボタンを押し、**テストモード**でデータベースを初期化します。
    -   **重要:** このステップを忘れると、アプリはデータベースに接続できず`400`エラーが発生します。
    -   ロケーションは任意ですが、`asia-northeast1` (東京) などがおすすめです。

### ステップ5: 最初の管理者ユーザーを手動で作成する (最重要)

アプリに初めてログインするために、管理者アカウントをFirebaseに手動で作成します。

#### 1. Authenticationで管理者を作成

1.  Firebaseコンソールの `Authentication` > `Users` タブを開きます。
2.  「**ユーザーを追加**」ボタンを押します。
3.  以下の情報でユーザーを作成します。
    -   **メールアドレス**: `admin@admin.com`
    -   **パスワード**: `admin123`
4.  作成後、一覧に表示された`admin@admin.com`の**「ユーザーUID」**をコピーします。これがユーザー固有のIDです。

#### 2. Firestoreに管理者プロファイルを作成

1.  次に `Firestore Database` に移動します。
2.  「**コレクションを開始**」をクリックし、コレクションIDに `users` と入力します。
3.  「**ドキュメントID**」の入力欄に、**先ほどコピーした「ユーザーUID」を貼り付けます。**
4.  以下の3つの**フィールド**を追加します: `name` (string): `管理者`, `email` (string): `admin@admin.com`, `role` (string): `管理者`
5.  「**保存**」ボタンを押します。

### ステップ6: セキュリティルールとインデックスのデプロイ (重要)

`Missing or insufficient permissions` エラーを解決し、アプリを安全に運用するために、セキュリティルールとデータベースインデックスをデプロイします。

1.  あなたのPCに[Firebase CLI](https://firebase.google.com/docs/cli)をインストールします (`npm install -g firebase-tools`)。
2.  プロジェクトのルートディレクトリでターミナルを開き、`firebase login`でログインします。
3.  `firebase use --add`であなたのFirebaseプロジェクトを選択します。
4.  以下のコマンドを実行して、**セキュリティルール**をデプロイします:
    ```bash
    firebase deploy --only firestore:rules
    ```
5.  以下のコマンドを実行して、**データベースインデックス**をデプロイします:
    ```bash
    firebase deploy --only firestore:indexes
    ```

これでセットアップは完了です！アプリケーションを開き、`admin@admin.com`と設定したパスワードでログインしてください。

## 🔧 管理者によるユーザー作成について

このアプリの「新規ユーザー作成」機能は、Firestoreにユーザープロファイルを作成するものです。セキュリティ上のベストプラクティスとして、クライアントアプリから直接Firebase Authenticationにユーザーを作成することは推奨されません。

**推奨される運用フロー:**
1.  管理者がアプリ内で「新規ユーザー作成」を行います（Firestoreにプロファイルが作成されます）。
2.  **別途、管理者がFirebaseコンソールで、同じメールアドレスとパスワードでAuthenticationユーザーを作成します。**
3.  その際、Authenticationで発行されたUIDが、FirestoreのドキュメントIDと一致していることを確認します。

将来的には、Cloud Functionsを使用して、Firestoreへのプロファイル作成をトリガーに、サーバー側で安全にAuthenticationユーザーを作成する自動化が理想的です。
